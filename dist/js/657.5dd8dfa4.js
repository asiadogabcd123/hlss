"use strict";(self["webpackChunkhlss"]=self["webpackChunkhlss"]||[]).push([[657],{8657:function(e,s,a){a.r(s),a.d(s,{default:function(){return fe}});var i=a(6768),t=a(4232),c=a(5130);const n={class:"modern-scanner"},r={class:"scanner-header"},l={class:"mode-toggle"},u={class:"scanner-body"},o={class:"scan-section"},d={class:"scanner-visual"},g={class:"scanner-frame"},h={class:"scan-instruction"},k={key:1,class:"id-card-section"},f={class:"id-card-input"},m={class:"input-group"},v=["disabled"],L={class:"scanner-visual"},p={class:"scanner-frame"},C={class:"scan-instruction"},T={key:2,class:"scan-history"},I={class:"history-items"},S={key:0,class:"history-item"},y={class:"item-detail"},E={key:1,class:"history-item"},b={class:"item-detail"},w={key:2,class:"history-item"},M={class:"item-detail"},N={key:0,class:"match-result"},O={class:"result-indicator success"},R={class:"info-section"},D={class:"info-card"},_={class:"card-body"},P={key:0,class:"empty-state"},x={key:1,class:"order-details"},X={class:"detail-grid"},Q={class:"detail-item"},V={class:"value"},$={class:"detail-item"},z={class:"value"},W={class:"detail-item"},j={class:"value"},A={key:0,class:"detail-item"},J={class:"value"},U={class:"detail-item"},F={class:"value"},G={class:"detail-item"},q={class:"value"},B={key:1,class:"detail-item"},K={class:"value"},Z={key:0,class:"overdue-alert"},H={class:"alert-content"},Y={class:"fee"},ee={class:"action-card"},se={class:"card-body"},ae={key:0,class:"verification-status"},ie={class:"action-buttons"},te=["disabled"],ce=["disabled"],ne={class:"toast-content"},re={class:"toast-message"},le={class:"toast-title"},ue={class:"toast-text"};function oe(e,s,a,oe,de,ge){return(0,i.uX)(),(0,i.CE)("div",n,[(0,i.Lk)("div",r,[s[15]||(s[15]=(0,i.Lk)("div",{class:"header-content"},null,-1)),(0,i.Lk)("div",l,[(0,i.Lk)("button",{class:(0,t.C4)(["toggle-btn",{active:!de.useIdCardMode}]),onClick:s[0]||(s[0]=(...e)=>ge.switchToQrMode&&ge.switchToQrMode(...e))},s[13]||(s[13]=[(0,i.Lk)("i",{class:"fas fa-qrcode"},null,-1),(0,i.eW)(" 二維碼取件 ")]),2),(0,i.Lk)("button",{class:(0,t.C4)(["toggle-btn",{active:de.useIdCardMode}]),onClick:s[1]||(s[1]=(...e)=>ge.switchToIdCardMode&&ge.switchToIdCardMode(...e))},s[14]||(s[14]=[(0,i.Lk)("i",{class:"fas fa-id-card"},null,-1),(0,i.eW)(" 身份證取件 ")]),2)])]),(0,i.Lk)("div",u,[(0,i.Lk)("div",o,[de.useIdCardMode?((0,i.uX)(),(0,i.CE)("div",k,[(0,i.Lk)("div",f,[s[17]||(s[17]=(0,i.Lk)("h4",null,"身份證取件",-1)),s[18]||(s[18]=(0,i.Lk)("p",null,"請輸入客人的證件號碼",-1)),(0,i.Lk)("div",m,[(0,i.bo)((0,i.Lk)("input",{type:"text","onUpdate:modelValue":s[5]||(s[5]=e=>de.idCardNumber=e),placeholder:"請輸入證件號碼",disabled:de.hasScannedLuggageTag,onKeyup:s[6]||(s[6]=(0,c.jR)((...e)=>ge.focusScanner&&ge.focusScanner(...e),["enter"])),ref:"idCardInput"},null,40,v),[[c.Jo,de.idCardNumber]])])]),(0,i.Lk)("div",{class:"scan-area",onClick:s[9]||(s[9]=(...e)=>ge.focusScanner&&ge.focusScanner(...e))},[(0,i.Lk)("div",L,[(0,i.Lk)("div",p,[(0,i.Lk)("div",{class:(0,t.C4)(["laser",{active:de.isScanning}])},null,2),(0,i.Lk)("i",{class:(0,t.C4)(["scan-icon",ge.scanIconClass])},null,2)])]),(0,i.Lk)("div",C,[(0,i.Lk)("p",null,(0,t.v_)(ge.idCardScanGuideText),1),s[19]||(s[19]=(0,i.Lk)("small",null,"點擊掃描區域激活掃描器",-1))]),(0,i.bo)((0,i.Lk)("input",{type:"text",class:"scanner-input","onUpdate:modelValue":s[7]||(s[7]=e=>de.scanInput=e),onKeyup:s[8]||(s[8]=(0,c.jR)((...e)=>ge.handleIdCardScan&&ge.handleIdCardScan(...e),["enter"])),ref:"scannerInputIdCard",autocomplete:"off",inputmode:"text",spellcheck:"false"},null,544),[[c.Jo,de.scanInput]])])])):((0,i.uX)(),(0,i.CE)("div",{key:0,class:"scan-area",onClick:s[4]||(s[4]=(...e)=>ge.focusScanner&&ge.focusScanner(...e))},[(0,i.Lk)("div",d,[(0,i.Lk)("div",g,[(0,i.Lk)("div",{class:(0,t.C4)(["laser",{active:de.isScanning}])},null,2),(0,i.Lk)("i",{class:(0,t.C4)(["scan-icon",ge.scanIconClass])},null,2)])]),(0,i.Lk)("div",h,[(0,i.Lk)("p",null,(0,t.v_)(ge.scanGuideText),1),s[16]||(s[16]=(0,i.Lk)("small",null,"點擊掃描區域激活掃描器，請掃描客人的取件憑證二維碼",-1))]),(0,i.bo)((0,i.Lk)("input",{type:"text",class:"scanner-input","onUpdate:modelValue":s[2]||(s[2]=e=>de.scanInput=e),onKeyup:s[3]||(s[3]=(0,c.jR)((...e)=>ge.handleScan&&ge.handleScan(...e),["enter"])),ref:"scannerInput",autocomplete:"off",inputmode:"text",spellcheck:"false"},null,544),[[c.Jo,de.scanInput]])])),de.hasScannedCustomerTicket||de.hasScannedLuggageTag||de.idCardNumber?((0,i.uX)(),(0,i.CE)("div",T,[s[24]||(s[24]=(0,i.Lk)("h4",null,"掃描記錄",-1)),(0,i.Lk)("div",I,[de.hasScannedCustomerTicket?((0,i.uX)(),(0,i.CE)("div",S,[s[20]||(s[20]=(0,i.Lk)("div",{class:"item-type customer"},[(0,i.Lk)("i",{class:"fas fa-ticket-alt"}),(0,i.Lk)("span",null,"客人取件憑證")],-1)),(0,i.Lk)("div",y,"行李ID: "+(0,t.v_)(de.customerTicket?.luggageId)+" | 客人: "+(0,t.v_)(de.luggageOrder?.guestName),1)])):(0,i.Q3)("",!0),de.hasScannedLuggageTag?((0,i.uX)(),(0,i.CE)("div",E,[s[21]||(s[21]=(0,i.Lk)("div",{class:"item-type luggage"},[(0,i.Lk)("i",{class:"fas fa-tag"}),(0,i.Lk)("span",null,"行李標籤")],-1)),(0,i.Lk)("div",b,"行李ID: "+(0,t.v_)(de.luggageTag?.luggageId),1)])):(0,i.Q3)("",!0),de.idCardNumber?((0,i.uX)(),(0,i.CE)("div",w,[s[22]||(s[22]=(0,i.Lk)("div",{class:"item-type id-card"},[(0,i.Lk)("i",{class:"fas fa-id-card"}),(0,i.Lk)("span",null,"身份證號碼")],-1)),(0,i.Lk)("div",M,(0,t.v_)(de.idCardNumber),1)])):(0,i.Q3)("",!0)]),de.hasScannedCustomerTicket||de.idCardNumber&&de.hasScannedLuggageTag?((0,i.uX)(),(0,i.CE)("div",N,[(0,i.Lk)("div",O,[s[23]||(s[23]=(0,i.Lk)("i",{class:"fas fa-check-circle"},null,-1)),(0,i.Lk)("span",null,(0,t.v_)(ge.matchResultText),1)])])):(0,i.Q3)("",!0)])):(0,i.Q3)("",!0)]),(0,i.Lk)("div",R,[(0,i.Lk)("div",D,[s[36]||(s[36]=(0,i.Lk)("div",{class:"card-header"},[(0,i.Lk)("i",{class:"fas fa-info-circle"}),(0,i.Lk)("h3",null,"訂單資訊")],-1)),(0,i.Lk)("div",_,[de.hasScannedCustomerTicket||de.hasScannedLuggageTag||de.idCardNumber?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",P,s[25]||(s[25]=[(0,i.Lk)("i",{class:"fas fa-id-card-alt"},null,-1),(0,i.Lk)("h4",null,"請先選擇取件方式",-1),(0,i.Lk)("p",null,"二維碼取件：掃描客人取件憑證 → 確認取件",-1),(0,i.Lk)("p",null,"身份證取件：輸入身份證 → 掃描行李標籤 → 確認取件",-1)]))),de.luggageOrder?((0,i.uX)(),(0,i.CE)("div",x,[(0,i.Lk)("div",X,[(0,i.Lk)("div",Q,[s[26]||(s[26]=(0,i.Lk)("label",null,"行李ID",-1)),(0,i.Lk)("div",V,(0,t.v_)(de.luggageOrder.id),1)]),(0,i.Lk)("div",$,[s[27]||(s[27]=(0,i.Lk)("label",null,"客人姓名",-1)),(0,i.Lk)("div",z,(0,t.v_)(de.luggageOrder.guestName),1)]),(0,i.Lk)("div",W,[s[28]||(s[28]=(0,i.Lk)("label",null,"行李數量",-1)),(0,i.Lk)("div",j,(0,t.v_)(de.luggageOrder.luggageCount)+" 件",1)]),de.luggageOrder.phoneLast4?((0,i.uX)(),(0,i.CE)("div",A,[s[29]||(s[29]=(0,i.Lk)("label",null,"手機尾號",-1)),(0,i.Lk)("div",J,"****"+(0,t.v_)(de.luggageOrder.phoneLast4),1)])):(0,i.Q3)("",!0),(0,i.Lk)("div",U,[s[30]||(s[30]=(0,i.Lk)("label",null,"寄存時間",-1)),(0,i.Lk)("div",F,(0,t.v_)(ge.formatDateTime(de.luggageOrder.checkinTime)),1)]),(0,i.Lk)("div",G,[s[31]||(s[31]=(0,i.Lk)("label",null,"當前狀態",-1)),(0,i.Lk)("div",q,[(0,i.Lk)("span",{class:(0,t.C4)(["status-badge",de.luggageOrder.status.toLowerCase()])},(0,t.v_)(de.statusMap[de.luggageOrder.status]),3)])]),de.idCardNumber?((0,i.uX)(),(0,i.CE)("div",B,[s[32]||(s[32]=(0,i.Lk)("label",null,"身份證號",-1)),(0,i.Lk)("div",K,(0,t.v_)(de.idCardNumber),1)])):(0,i.Q3)("",!0)]),"EXPIRED"===de.luggageOrder.status?((0,i.uX)(),(0,i.CE)("div",Z,[s[35]||(s[35]=(0,i.Lk)("div",{class:"alert-icon"},[(0,i.Lk)("i",{class:"fas fa-exclamation-triangle"})],-1)),(0,i.Lk)("div",H,[s[34]||(s[34]=(0,i.Lk)("h5",null,"超期寄存提醒",-1)),(0,i.Lk)("p",null,"此行李已寄存 "+(0,t.v_)(ge.storageDays)+" 天，超過免費寄存期限(3天)",1),(0,i.Lk)("p",Y,[s[33]||(s[33]=(0,i.eW)("需收取超期費用: ")),(0,i.Lk)("span",null,"MOP "+(0,t.v_)(ge.overdueFee.toFixed(2)),1)])])])):(0,i.Q3)("",!0)])):(0,i.Q3)("",!0)])]),(0,i.Lk)("div",ee,[s[39]||(s[39]=(0,i.Lk)("div",{class:"card-header"},[(0,i.Lk)("i",{class:"fas fa-check-square"}),(0,i.Lk)("h3",null,"取件操作")],-1)),(0,i.Lk)("div",se,[de.verificationStatus?((0,i.uX)(),(0,i.CE)("div",ae,[(0,i.Lk)("div",{class:(0,t.C4)(["status-message",de.verificationStatus])},[(0,i.Lk)("i",{class:(0,t.C4)(["fas",ge.verificationIcon])},null,2),(0,i.Lk)("span",null,(0,t.v_)(de.verificationMessage),1)],2)])):(0,i.Q3)("",!0),(0,i.Lk)("div",ie,[(0,i.Lk)("button",{class:"btn-primary",disabled:!ge.canRetrieve||de.isProcessing,onClick:s[10]||(s[10]=(...e)=>ge.retrieveLuggage&&ge.retrieveLuggage(...e))},[s[37]||(s[37]=(0,i.Lk)("i",{class:"fas fa-check-circle"},null,-1)),(0,i.eW)(" "+(0,t.v_)("RETRIEVED"===de.luggageOrder?.status?"已完成取件":"確認取件"),1)],8,te),(0,i.Lk)("button",{class:"btn-secondary",onClick:s[11]||(s[11]=(...e)=>ge.resetScanner&&ge.resetScanner(...e)),disabled:de.isProcessing},s[38]||(s[38]=[(0,i.Lk)("i",{class:"fas fa-redo"},null,-1),(0,i.eW)(" 重新掃描 ")]),8,ce)])])])])]),(0,i.bF)(c.eB,{name:"fade"},{default:(0,i.k6)(()=>[de.showNotification?((0,i.uX)(),(0,i.CE)("div",{key:0,class:(0,t.C4)(["notification-toast",de.notificationType])},[(0,i.Lk)("div",ne,[(0,i.Lk)("i",{class:(0,t.C4)(["toast-icon",ge.notificationIcon])},null,2),(0,i.Lk)("div",re,[(0,i.Lk)("div",le,(0,t.v_)(de.notificationTitle),1),(0,i.Lk)("div",ue,(0,t.v_)(de.notificationMessage),1)])]),(0,i.Lk)("button",{class:"toast-close",onClick:s[12]||(s[12]=e=>de.showNotification=!1)},s[40]||(s[40]=[(0,i.Lk)("i",{class:"fas fa-times"},null,-1)]))],2)):(0,i.Q3)("",!0)]),_:1})])}a(8111),a(7588);var de=a(1928),ge={name:"LuggagePickupSystem",data(){return{useIdCardMode:!1,idCardNumber:"",hasScannedCustomerTicket:!1,hasScannedLuggageTag:!1,customerTicket:null,luggageTag:null,luggageOrder:null,scanInput:"",isScanning:!1,scanSuccess:!1,focusTimer:null,isProcessing:!1,verificationStatus:"",verificationMessage:"",showNotification:!1,notificationType:"success",notificationTitle:"",notificationMessage:"",statusMap:{STORED:"寄存中",EXPIRED:"已過期",RETRIEVED:"已取件"}}},computed:{hasScannedEnough(){return this.useIdCardMode?this.idCardNumber&&this.hasScannedLuggageTag:this.hasScannedCustomerTicket},scanGuideText(){return"RETRIEVED"===this.luggageOrder?.status?"此訂單已完成取件，可點擊「重新掃描」開始新流程":this.hasScannedCustomerTicket?`已識別行李ID: ${this.customerTicket?.luggageId}，請確認取件`:"請掃描客人的取件憑證二維碼"},idCardScanGuideText(){return"RETRIEVED"===this.luggageOrder?.status?"此訂單已完成取件":this.idCardNumber?this.hasScannedLuggageTag?"行李標籤已掃描，請確認取件":"請掃描行李標籤":"請先輸入身份證號碼"},matchResultText(){return this.useIdCardMode?"身份證與行李標籤已驗證，可進行取件":"客人取件憑證已驗證，可進行取件"},scanStatus(){return"RETRIEVED"===this.luggageOrder?.status?"completed":this.hasScannedEnough?"success":this.idCardNumber||this.hasScannedCustomerTicket?"scanning":"idle"},scanIconClass(){return"RETRIEVED"===this.luggageOrder?.status?"fas fa-check-circle completed":this.hasScannedEnough?"fas fa-check-circle success":this.idCardNumber||this.hasScannedCustomerTicket?"fas fa-qrcode scanning":"fas fa-camera idle"},canRetrieve(){return this.hasScannedEnough&&this.luggageOrder&&"RETRIEVED"!==this.luggageOrder.status},notificationIcon(){return{success:"fas fa-check-circle",error:"fas fa-exclamation-circle",info:"fas fa-info-circle"}[this.notificationType]},verificationIcon(){switch(this.verificationStatus){case"success":return"fa-check-circle";case"error":return"fa-exclamation-circle";default:return"fa-info-circle"}},storageDays(){if(!this.luggageOrder||!this.luggageOrder.checkinTime)return 0;const e=new Date(this.luggageOrder.checkinTime),s=new Date,a=Math.abs(s-e);return Math.ceil(a/864e5)},overdueFee(){if("EXPIRED"!==this.luggageOrder?.status||!this.luggageOrder.luggageCount)return 0;const e=Math.max(0,this.storageDays-3),s=20;return e*s*this.luggageOrder.luggageCount}},methods:{switchToIdCardMode(){this.useIdCardMode=!0,this.resetScanner(),this.$nextTick(()=>{this.$refs.idCardInput&&this.$refs.idCardInput.focus()})},switchToQrMode(){this.useIdCardMode=!1,this.resetScanner()},async handleIdCardScan(){if(this.scanInput&&"RETRIEVED"!==this.luggageOrder?.status&&!this.isProcessing)if(this.idCardNumber){this.isProcessing=!0;try{const e=this.scanInput.trim(),s=e.replace(/[\r\n\s]+/g,"");let a=JSON.parse(s);if(a=this.normalizeCamelCase(a),!a.type||!a.luggageId)throw new Error("二維碼格式無效，缺少「type」或「luggageId」");if("luggage_tag"!==a.type)throw new Error("請掃描「行李標籤」（二維碼類型需為 luggage_tag）");await this.processLuggageTag(a)}catch(e){console.error("掃描錯誤:",e),this.showNotificationMessage("error","識別失敗",`${e.message}，請檢查二維碼或切換輸入法為英文`),this.scanSuccess=!1}finally{setTimeout(()=>{this.scanInput="",this.isProcessing=!1},3e3)}}else this.showNotificationMessage("error","操作失敗","請先輸入身份證號碼")},formatDateTime(e){if(!e)return"";const s=new Date(e);return s.toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},showNotificationMessage(e,s,a){this.notificationType=e,this.notificationTitle=s,this.notificationMessage=a,this.showNotification=!0,setTimeout(()=>{this.showNotification=!1},3500)},focusScanner(){let e=this.useIdCardMode?this.$refs.scannerInputIdCard:this.$refs.scannerInput;e&&"RETRIEVED"!==this.luggageOrder?.status&&(this.isScanning=!0,document.activeElement===e?(e.blur(),setTimeout(()=>{e.focus({preventScroll:!0})},50)):e.focus({preventScroll:!0}),setTimeout(()=>{this.isScanning=!1},2e3))},async handleScan(){if(this.scanInput&&"RETRIEVED"!==this.luggageOrder?.status&&!this.isProcessing){this.isProcessing=!0;try{const e=this.scanInput.trim(),s=e.replace(/[\r\n\s]+/g,"");let a=JSON.parse(s);if(a=this.normalizeCamelCase(a),!a.type||!a.luggageId)throw new Error("二維碼格式無效，缺少「type」或「luggageId」");if("customer_ticket"!==a.type)throw new Error("請掃描「客人取件憑證」（二維碼類型需為 customer_ticket）");await this.processCustomerTicket(a)}catch(e){console.error("掃描錯誤:",e),this.showNotificationMessage("error","識別失敗",`${e.message}，請檢查二維碼或切換輸入法為英文`),this.scanSuccess=!1}finally{setTimeout(()=>{this.scanInput="",this.isProcessing=!1},3e3)}}},normalizeCamelCase(e){if("object"!==typeof e||null===e)return e;const s={};return Object.keys(e).forEach(a=>{const i=a.replace(/_([a-z])/g,(e,s)=>s.toUpperCase()).replace(/^([a-z])/,(e,s)=>s.toLowerCase()).replace(/([a-z])([A-Z])/g,(e,s,a)=>s+a),t="luggageid"===i?"luggageId":"guestname"===i?"guestName":"checkintime"===i?"checkinTime":i;s[t]=e[a]}),s.checkinTime&&"string"===typeof s.checkinTime&&(s.checkinTime=s.checkinTime.replace("t","T")),s},async processCustomerTicket(e){try{this.isProcessing=!0;const s=Number(e.luggageId);if(isNaN(s))throw new Error("二維碼中的 luggageId 不是有效數字");const{data:a}=await de.A.getLuggageById(s);this.luggageOrder=a,this.customerTicket={...e,luggageId:s,checkinTime:a.checkinTime},this.hasScannedCustomerTicket=!0,this.scanSuccess=!0,this.verificationStatus="success",this.verificationMessage=`已成功識別客人憑證（行李ID: ${s}），請確認取件`,this.showNotificationMessage("success","識別成功","可進行取件確認")}catch(s){this.verificationStatus="error";const e=s.response?.data?.message||"訂單查詢失敗，請聯繫管理員";throw this.verificationMessage=`客人憑證處理失敗：${e}`,this.showNotificationMessage("error","操作失敗",e),new Error(`訂單查詢錯誤：${e}`)}finally{this.isProcessing=!1}},async processLuggageTag(e){try{this.isProcessing=!0;const s=Number(e.luggageId);if(isNaN(s))throw new Error("行李標籤中的 luggageId 不是有效數字");const{data:a}=await de.A.getLuggageById(s);this.luggageOrder=a,this.luggageTag={type:e.type,luggageId:s},this.hasScannedLuggageTag=!0,this.scanSuccess=!0,this.verificationStatus="success",this.verificationMessage="行李標籤掃描成功，請確認取件",this.showNotificationMessage("success","掃描成功","可進行取件確認")}catch(s){this.showNotificationMessage("error","行李標籤處理失敗",s.message)}finally{this.isProcessing=!1}},async retrieveLuggage(){if(this.canRetrieve&&!this.isProcessing){this.isProcessing=!0;try{const e={scannedLuggage:[this.luggageTag?.luggageId||this.customerTicket?.luggageId],idCardNumber:this.useIdCardMode?this.idCardNumber:null},{data:s}=await de.A.completeRetrieval(this.luggageOrder.id,e);if(!s.success)throw new Error("後端處理取件失敗，請重試");this.luggageOrder.status="RETRIEVED",this.verificationStatus="success",this.verificationMessage="訂單已標記為「已取件」",this.showNotificationMessage("success","取件完成",`行李ID ${this.luggageOrder.id} 已成功交還，費用已記錄`)}catch(e){this.verificationStatus="error";const s=e.response?.data?.message||"取件操作失敗，請聯繫管理員";this.verificationMessage=`取件失敗：${s}`,this.showNotificationMessage("error","操作失敗",s)}finally{this.isProcessing=!1}}},resetScanner(){this.focusTimer&&clearInterval(this.focusTimer),this.hasScannedCustomerTicket=!1,this.hasScannedLuggageTag=!1,this.customerTicket=null,this.luggageTag=null,this.luggageOrder=null,this.scanInput="",this.useIdCardMode||(this.idCardNumber=""),this.scanSuccess=!1,this.verificationStatus="",this.verificationMessage="",this.isProcessing=!1}},mounted(){},beforeUnmount(){this.focusTimer&&clearInterval(this.focusTimer)}},he=a(1241);const ke=(0,he.A)(ge,[["render",oe],["__scopeId","data-v-4f329598"]]);var fe=ke}}]);
//# sourceMappingURL=657.5dd8dfa4.js.map